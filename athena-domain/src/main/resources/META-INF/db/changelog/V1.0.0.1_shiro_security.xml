<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="create_sec_user_table" author="gmalikov" dbms="oracle">
        <sql>
            CREATE TABLE SEC_USER (
            ID       INTEGER GENERATED BY DEFAULT ON NULL AS IDENTITY,
            USERNAME VARCHAR2(255),
            PASSWORD VARCHAR2(255),
            SALT     VARCHAR2(255),
            NAME     VARCHAR2(255)
            );

            COMMENT ON COLUMN SEC_USER.ID IS 'Primary key';
            COMMENT ON COLUMN SEC_USER.USERNAME IS 'Username';
            COMMENT ON COLUMN SEC_USER.PASSWORD IS 'Password';
            COMMENT ON COLUMN SEC_USER.SALT IS 'Salt for password encoding';
            COMMENT ON COLUMN SEC_USER.NAME IS 'Displayed username';
        </sql>
        <rollback>
            <sql>
                DROP TABLE SEC_USER;
            </sql>
        </rollback>
    </changeSet>

    <changeSet id="sec_user_constraints" author="gmalikov" dbms="oracle">
        <sql>
            ALTER TABLE SEC_USER ADD CONSTRAINT PK_SEC_USER PRIMARY KEY (ID);
        </sql>
        <rollback>
            <sql>
                ALTER TABLE SEC_USER DROP CONSTRAINT PK_SEC_USER;
            </sql>
        </rollback>
    </changeSet>

    <changeSet id="sec_role_table" author="gmalikov" dbms="oracle">
        <sql>
            CREATE TABLE SEC_ROLE (
            ID   INTEGER GENERATED BY DEFAULT ON NULL AS IDENTITY,
            NAME VARCHAR2(255)
            );

            COMMENT ON COLUMN SEC_ROLE.ID IS 'Primary key';
            COMMENT ON COLUMN SEC_ROLE.NAME IS 'Role name';
        </sql>
        <rollback>
            <sql>
                DROP TABLE SEC_ROLE;
            </sql>
        </rollback>
    </changeSet>

    <changeSet id="sec_role_constraints" author="gmalikov" dbms="oracle">
        <sql>
            ALTER TABLE SEC_ROLE ADD CONSTRAINT PK_SEC_ROLE PRIMARY KEY (ID);
        </sql>
        <rollback>
            <sql>
                ALTER TABLE SEC_ROLE DROP CONSTRAINT PK_SEC_ROLE;
            </sql>
        </rollback>
    </changeSet>

    <changeSet id="sec_user_role" author="gmalikov" dbms="oracle">
        <sql>
            CREATE TABLE SEC_USER_ROLE(
            USER_ID INTEGER NOT NULL,
            ROLE_ID INTEGER NOT NULL
            );
            COMMENT ON COLUMN SEC_USER_ROLE.USER_ID IS 'Foreign key to SEC_USER';
            COMMENT ON COLUMN SEC_USER_ROLE.ROLE_ID IS 'Foreign key to SEC_ROLE';
        </sql>
        <rollback>
            <sql>
                DROP TABLE SEC_USER_ROLE;
            </sql>
        </rollback>
    </changeSet>

    <changeSet id="sec_user_role_constraints" author="gmalikov">
        <sql>
            ALTER TABLE SEC_USER_ROLE ADD CONSTRAINT FK_SEC_USER_ROLE_USER FOREIGN KEY (USER_ID) REFERENCES SEC_USER(ID);
            ALTER TABLE SEC_USER_ROLE ADD CONSTRAINT FK_SEC_USER_ROLE_ROLE FOREIGN KEY (ROLE_ID) REFERENCES SEC_ROLE(ID);
        </sql>
        <rollback>
            <sql>
                ALTER TABLE SEC_USER_ROLE DROP CONSTRAINT FK_SEC_USER_ROLE_USER;
                ALTER TABLE SEC_USER_ROLE DROP CONSTRAINT FK_SEC_USER_ROLE_ROLE;
            </sql>
        </rollback>
    </changeSet>

    <changeSet id="sec_action_table" author="gmalikov">
        <sql>
            CREATE TABLE SEC_ACTION (
            ID   INTEGER NOT NULL,
            NAME VARCHAR2(255)
            );
            COMMENT ON COLUMN SEC_ACTION.ID IS 'Primary key';
            COMMENT ON COLUMN SEC_ACTION.NAME IS 'Action name';
        </sql>
        <rollback>
            <sql>
                DROP TABLE SEC_ACTION;
            </sql>
        </rollback>
    </changeSet>

    <changeSet id="sec_action_constraints" author="gmalikov">
        <sql>
            ALTER TABLE SEC_ACTION ADD CONSTRAINT PK_SEC_ACTION PRIMARY KEY (ID);
        </sql>
        <rollback>
            <sql>
                ALTER TABLE SEC_ACTION DROP CONSTRAINT PK_SEC_ACTION;
            </sql>
        </rollback>
    </changeSet>

    <changeSet id="sec_role_action_table" author="gmalikov">
        <sql>
            CREATE TABLE SEC_ROLE_ACTION (
            ROLE_ID   INTEGER NOT NULL,
            ACTION_ID INTEGER NOT NULL
            );
            COMMENT ON COLUMN SEC_ROLE_ACTION.ROLE_ID IS 'Foreign key to SEC_ROLE';
            COMMENT ON COLUMN SEC_ROLE_ACTION.ACTION_ID IS 'Foreign key to SEC_ACTION';
        </sql>
        <rollback>
            <sql>
                DROP TABLE SEC_ROLE_ACTION;
            </sql>
        </rollback>
    </changeSet>

    <changeSet id="sec_role_action_constraints" author="gmalikov">
        <sql>
            ALTER TABLE SEC_ROLE_ACTION ADD CONSTRAINT FK_SEC_ROLE_ACTION_ROLE FOREIGN KEY (ROLE_ID) REFERENCES SEC_ROLE(ID);
            ALTER TABLE SEC_ROLE_ACTION ADD CONSTRAINT FK_SEC_ROLE_ACTION_ACTION FOREIGN KEY (ACTION_ID) REFERENCES SEC_ACTION(ID);
        </sql>
        <rollback>
            <sql>
                ALTER TABLE SEC_ROLE_ACTION DROP CONSTRAINT FK_SEC_ROLE_ACTION_ROLE;
                ALTER TABLE SEC_ROLE_ACTION DROP CONSTRAINT FK_SEC_ROLE_ACTION_ACTION;
            </sql>
        </rollback>
    </changeSet>
    
    <changeSet id="sec_domain" author="gmalikov">
        <sql>
            CREATE TABLE SEC_DOMAIN(
            ID INTEGER GENERATED BY DEFAULT ON NULL AS IDENTITY,
            NAME VARCHAR2 (255)
            );
            COMMENT ON COLUMN SEC_DOMAIN.ID IS 'Primary key';
            COMMENT ON COLUMN SEC_DOMAIN.NAME IS 'Domain name';
        </sql>
        <rollback>
            <sql>
                DROP TABLE SEC_DOMAIN;
            </sql>
        </rollback>
    </changeSet>

    <changeSet id="sec_domain_constraints" author="gmalikov">
        <sql>
            ALTER TABLE SEC_DOMAIN ADD CONSTRAINT PK_SEC_DOMAIN PRIMARY KEY (ID);
        </sql>
        <rollback>
            <sql>
                ALTER TABLE SEC_DOMAIN DROP CONSTRAINT PK_SEC_DOMAIN;
            </sql>
        </rollback>
    </changeSet>

    <changeSet id="sec_permission_table" author="gmalikov">
        <sql>
            CREATE TABLE SEC_PERMISSION (
            ID          INTEGER GENERATED BY DEFAULT ON NULL AS IDENTITY,
            USER_ID     INTEGER NOT NULL,
            ACTION_ID   INTEGER NOT NULL,
            DOMAIN_ID   INTEGER NOT NULL,
            INSTANCE_ID VARCHAR2(255)
            );
            COMMENT ON COLUMN SEC_PERMISSION.ID IS 'Primary key';
            COMMENT ON COLUMN SEC_PERMISSION.USER_ID IS 'Foreign key to SEC_USER';
            COMMENT ON COLUMN SEC_PERMISSION.ACTION_ID IS 'Foreign key to SEC_ACTION';
            COMMENT ON COLUMN SEC_PERMISSION.DOMAIN_ID IS 'Foreign key to SEC_DOMAIN';
            COMMENT ON COLUMN SEC_PERMISSION.INSTANCE_ID IS 'Instance id, or set of ids, separated by ;';
        </sql>
        <rollback>
            <sql>
                DROP TABLE SEC_PERMISSION;
            </sql>
        </rollback>
    </changeSet>

    <changeSet id="sec_permission_constraints" author="gmalikov">
        <sql>
            ALTER TABLE SEC_PERMISSION ADD CONSTRAINT PK_SEC_PERMISSION PRIMARY KEY (ID);
            ALTER TABLE SEC_PERMISSION ADD CONSTRAINT SEC_PERMISSION_USER FOREIGN KEY (USER_ID) REFERENCES SEC_USER (ID);
            ALTER TABLE SEC_PERMISSION ADD CONSTRAINT SEC_PERMISSION_ACTION FOREIGN KEY (ACTION_ID) REFERENCES SEC_ACTION (ID);
            ALTER TABLE SEC_PERMISSION ADD CONSTRAINT SEC_PERMISSION_DOMAIN FOREIGN KEY (DOMAIN_ID) REFERENCES SEC_DOMAIN (ID);
        </sql>
        <rollback>
            <sql>
                ALTER TABLE SEC_PERMISSION DROP CONSTRAINT PK_SEC_PERMISSION;
                ALTER TABLE SEC_PERMISSION DROP CONSTRAINT SEC_PERMISSION_USER;
                ALTER TABLE SEC_PERMISSION DROP CONSTRAINT SEC_PERMISSION_ACTION;
                ALTER TABLE SEC_PERMISSION DROP CONSTRAINT SEC_PERMISSION_DOMAIN;
            </sql>
        </rollback>
    </changeSet>

    <changeSet id="sec_role_permission" author="gmalikov">
        <sql>
            CREATE TABLE SEC_ROLE_PERMISSION (
            ROLE_ID       INTEGER NOT NULL,
            PERMISSION_ID INTEGER NOT NULL
            );
            COMMENT ON COLUMN SEC_ROLE_PERMISSION.ROLE_ID IS 'Foreign key to SEC_ROLE';
            COMMENT ON COLUMN SEC_ROLE_PERMISSION.PERMISSION_ID IS 'Foreign key to SEC_PERMISSION';
        </sql>
        <rollback>
            <sql>
                DROP TABLE SEC_ROLE_PERMISSION;
            </sql>
        </rollback>
    </changeSet>

    <changeSet id="sec_role_permission_constraints" author="gmalikov">
        <sql>
            ALTER TABLE SEC_ROLE_PERMISSION ADD CONSTRAINT SEC_ROLE_PERM_ROLE FOREIGN KEY (ROLE_ID) REFERENCES SEC_ROLE(ID);
            ALTER TABLE SEC_ROLE_PERMISSION ADD CONSTRAINT SEC_ROLE_PERM_PERM FOREIGN KEY (PERMISSION_ID) REFERENCES SEC_PERMISSION(ID);
        </sql>
        <rollback>
            <sql>
                ALTER TABLE SEC_ROLE_PERMISSION DROP CONSTRAINT SEC_ROLE_PERM_ROLE;
                ALTER TABLE SEC_ROLE_PERMISSION DROP CONSTRAINT SEC_ROLE_PERM_PERM;
            </sql>
        </rollback>
    </changeSet>
</databaseChangeLog>